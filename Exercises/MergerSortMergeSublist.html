<!--
####################################### Merge Sort ##################################################
#  Question     : Given 2 sublist which are sorted, merge them using merge sort
#  Variables    : arr_size 6 - 10
#  Chapter      : MergeSort
#  Author       : Gayathri
#  Date         : August 6, 2012
#######################################################################################################
-->

<!DOCTYPE html>
<html data-require="math">

	<head>
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
                <title>Merge SubList</title>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
                <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
                <script src="../JSAV/lib/jquery.transform.light.js"></script>
                <script type="text/javascript"
       src="http://cdn.mathjax.org/mathjax/1.1-latest/MathJax.js?config=http://algoviz.org/OpenDSA/dev/OpenDSA/ODSAkhan-exercises/KAthJax-77111459c7d82564a705f9c5480e2c88.js">
                </script>
		<script type="text/javascript" src="/MathJax/MathJax.js?config=default"></script>
                <script>urlBaseOverride = "../ODSAkhan-exercises/";</script>
                <script src="../ODSAkhan-exercises/khan-exercise.js"></script>
                <script src="../JSAV/build/JSAV-min.js"></script>
                <link rel="stylesheet" href="../JSAV/css/JSAV.css" type="text/css" />

		<style>
			#container {
				border: 0px;
                		width: 780px;
                		height: 640px;
                		padding: 10px;
                		overflow: hidden;
        		}

        		.jsavarray {
                		position: absolute;
        		}

        		#container .jsavarray {
                		left: -10px;
                		height: 80px;
        		}


		</style>
	</head>

	<body>

	<script>
  		var jsav, arr , arr_clone,arr_left, arr_right, myGuess, arrdata,useranswer,left_size, nsel, sel1 ;
  	  	var rowHeight = 80;                             // The space required for each row to be displayed
      		var canvasWidth = 800;                  // The width of the display
      		var blockWidth = 47;                    // The width of an array element

      		// Variables used to keep track of the index and the array of the currently selected element
      		var mergeValueIndex = -1;
    		var mergeValueArr = null;



		// function to handle a click event on an array
		function clickHandler(arr, index) {
			if (nsel == 0)    // No element is currently selected, select the current element
                	{
                        	// Don't let the user select an empty element
                        	if (arr.value(index) == "") return;
                        	arr.highlight(index);
				nsel = nsel+1;
                        	mergeValueArr = arr;
                       		mergeValueIndex = index;
                	} else {	
				if (arr == mergeValueArr && index == mergeValueIndex)
                		{
                        		// Deselect the currently selected element
                        		arr.unhighlight(index);
					nsel = nsel - 1;
                		}
				else if (arr != mergeValueArr) {
					// Don't let the user overwrite a merged element
                        		if (arr.value(index) != "") return;
					var arrLevel = getLevel(arr);
                        		var mvaLevel = getLevel(mergeValueArr);

                        		// Ensure the user only merges one level up, not down or too far up
                        		if (arrLevel == mvaLevel - 1)
                        		{
						// Complete merge by setting the value of the current element to the stored value
                             			arr.value(index, mergeValueArr.value(mergeValueIndex));
						useranswer.value(index, mergeValueArr.value(mergeValueIndex));
						// Clear values the user has already merged
                             			mergeValueArr.value(mergeValueIndex, "");
						mergeValueArr.unhighlight(mergeValueIndex);
						// Hide arrays once the user empties them
                                        	if (mergeValueArr.isEmpty())
                                        	{
                                                	mergeValueArr.hide();
                                        	}
						nsel =0;
					}
				}
				else if (arr == mergeValueArr) {
					var arrLevel = getLevel(arr);
					if (arrLevel  == 2) {
						arr.swap(index,mergeValueIndex);
						nsel=0;
						arr.unhighlight(index);
						arr.unhighlight(mergeValueIndex);
						var temp = useranswer.value(index);
						useranswer.value(index,useranswer.value(mergeValueIndex));
						useranswer.value(mergeValueIndex,temp);
					 }
				}
			}
			
		}

		// function that initialise JSAV library 
  		initJSAV = function(a) {
			var i;
			myGuess = -1;
			nsel = 0;
			jsav = new JSAV($("#container"));
			if ( a%2 == 0) {
      				left_size = (a/2);
      			} else {
      				left_size = (a-1)/2;
      			}
			
			arraydata = JSAV.utils.rand.numKeys(10, 100,a);
			initArrays(0,a-1, 2, 1,0);
			initArrays(0,left_size-1,3,1,1);
			initArrays(left_size,a-1,3,2,2);
			arraydata.sort(function(a,b){return a-b});
			arr_clone = jsav.ds.array(arraydata, {indexed: true, center: false, layout: "array"});
			arr_clone.hide();
			var emptycontent = new Array(a);
			useranswer = jsav.ds.array(emptycontent, {indexed: true, center: false, layout: "array"});
			useranswer.hide();
  		}
	
		// function that creates and initialises the arrays for mergesort
		function initArrays(l, r, level, column,data_type) {
			var i;
        		var numElements = r - l + 1;
        		var contents = new Array(numElements);
			if (data_type == 1)
			{
				for (i=0; i<numElements; i++) {
					contents[i]=arraydata[i];
				}
				contents.sort(function(a,b){return a-b});
			}
			if (data_type == 2)
      			{
        			for (i=0; i<numElements; i++) {
					contents[i]=arraydata[i+left_size];
				}
				 contents.sort(function(a,b){return a-b});
			}
                
			// Dynamically create and position arrays
        		var arr = jsav.ds.array(contents, {indexed: true, center: false, layout: "array"});
        		// Set the ID for the array
        		arr.element.attr("id", "array_" + level + "_" + column + "_" + l);
        		setPosition(arr, level, column);
        		// Attach the click handler to the array
        		arr.click(function(index){clickHandler(this, index)});
		}

		// function to position each array
		function setPosition(arr, level, column) {
                	// Calculate the number of arrays in the current row
                	var numArrInRow = Math.pow(2, level - 1);

                	// Calculate the left value of the current array by dividing
                	// the width of the canvas by twice the number of arrays that should appear in that
                	// row: (canvasWidth / (2 * numArrInRow))
                	// Odd multiples of the resulting value define a line through the center of each array
                	// in the row and are found using the formula (2 * column - 1)
                	// Note: while it is not used, even multiples define the center between two consecutive arrays
                	// Since we want the left value rather than the center value of each array we calculate
                	// the length each array (blockWidth *  arr.size()), divide this value in half and
                	// subtract it from the center line to find the left value

                	var left = (canvasWidth / (2 * numArrInRow)) * (2 * column - 1) - (blockWidth * arr.size() / 2);
                	var top = rowHeight * (level - 1);

                	// Set the top and left values so that all arrays are spaced properly
                	arr.element.css({"left": left, "top": top});
      		}
 
		// function that validates student's answer 
 		function checkAnswer (a) {
  			var i;
			// Return false if user has highlighted any position before start_pos
			for (i=0; i < a; i++) {
				if ( useranswer.value(i) != arr_clone.value(i)) return (2 === 1);
			}
			// All conditions passed, return true
  			return ( 1 === 1);
  		} 

		// function that returns the level of the given array
    		function getLevel(arr)
    		{
                	return parseArrId(arr)[0];
        	}

        	function parseArrId(arr)
        	{
                	var id = arr.element.attr("id");
                	var args = id.split("_");

                	var level = parseInt(args[1]);
                	var column = parseInt(args[2]);
                	var arrOffset = parseInt(args[3]);

                	return [level, column, arrOffset];
        	}
		
		// function that determines if array is empty
   
    		JSAV._types.ds.AVArray.prototype.isEmpty = function()
    		{
                	for (var i = 0; i < this.size(); i++)
                	{
                        	if (this.value(i) != "")
                        	{
                                	return false;
                        	}
                	}

                	return true;
        	}


	</script>


	<div class="exercise">
  		<div class="vars">
    			<var id="arr_size">randRange( 6, 10 )</var>
    			<var id="JSAV">initJSAV(arr_size)</var>
		</div>

  		<div class="problems">
    			<div>
      				<div class="question">
				<p> Merge the two sublists below using Merge Sort </p>
				<div id="jsav" class="jsavcanvas"></div>
      			</div>
      			<div class="solution" data-type="custom">
				<div class="guess">
          				[myGuess]
        			</div>
				<div class="validator-function">
	  				return checkAnswer (arr_size);
				</div>
      			</div>
     
		 	<div class="hints">
				<p> Merging the sorted subarrays results in a sorted final array </p>
      			</div>
    		</div>
  	</div>
</body>
</html>
