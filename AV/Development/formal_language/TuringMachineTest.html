<!DOCTYPE html>
<!--Version 5: Add State Labels -->
<html>
<head>
  <title>TM Test</title>
  <link rel="stylesheet" href="../../../JSAV/css/JSAV.css" type="text/css" />
  <style>
    #av {
      width: 98%;
      position: relative;
    }
    .jsavcounter {
      position: absolute;
      top: 15px;
    }
    .jsavlabel {
      font-size: 80%;
      text-align: center;
      margin: -6px 0 -10px 0;
      z-index: 150;
    }
    .jsavarray {
      top: 25px;
    }
  </style>
</head>
<body>
<div id="av">
  <div class="jsavcontrols"></div><span class="jsavcounter"></span>
</div>

<button onclick="testString()" id="testStringButton">Test String</button>
<button onclick="showQuestion()">Show Question</button>
<br>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="../../../JSAV/lib/jquery.transit.js"></script>
<script src="../../../JSAV/lib/raphael.js"></script>
<script src="../../../JSAV/lib/dagre.min.js"></script>
<script src="../../../JSAV/build/JSAV.js"></script>
<script src="../../../lib/odsaUtils-min.js"></script>
<script src="../../../lib/odsaAV-min.js"></script>
<script src="./fa/serializableGraph.js"></script>
<script src="./fa/underscore-min.js"></script>
<script src="./fa/Automaton.js"></script>
<script src="./CustomPrompt.js"></script>
<script src="./fa/Commands.js"></script>
<script src="./TuringMachine.js" type="text/javascript" ></script>

<script>

var jsav = new JSAV("av");
tm = jsav.ds.tm($.extend({width: '90%', height: 440, emptystring: "", editable: true}, opts));
//
var textArray = [];

// do I need to add states? I need to be able to display these
// //(start, end, toRead, toWrite, direction)
// var state1 = tm.addTransition(3, 1, "#ffddff", false, 1);
// var state2 = tm.addTransition(5, 2, "#ffddff", false, 1);
// var state3 = tm.addTransition(7, 1, "#ffddff", false, 1);
// var state4 = tm.addTransition(5, 3, "#ffddff", true, 1);
//
// state1.addNextState(state1, ["0"]);
// state1.addNextState(state2, ["1"]);
//
// state2.addNextState(state1, ["0"]);
// state2.addNextState(state3, ["1"]);
//
// state3.addNextState(state1, ["0"]);
// state3.addNextState(state4, ["1"]);
//
// state4.addNextState(state1, ["0"]);
// state4.addNextState(state4, ["1"]);

// tm.draw(jsav);
jsav.label("TM Test", {top: 10, left: 500}).css({"font-size": "150%"});
jsav.displayInit();

function testString() {
  var input = prompt("Enter a string:", "aabbcc");
  if (input != null) {
      // $("#testStringButton").hide();
      myJsFunction(input);
  }
}


function myJsFunction(input) {
  var text = input;
  for (var i = 0; i < text.length; i++) {
    textArray.push(text.charAt(i));
  }

  var arr1 = jsav.ds.tm.array;

  for (var i = 0; i < textArray.length; i++) {
    var result = tm.traverse(text.charAt(i));

    // Invalid result from rejected character
    if (result == -1) {
        arr1.css(i, {"background-color": "#ff2222"});
        break;
    }
    arr1.css(i, {"background-color": "#ffaaaa"});
    jsav.step();
  }

  if (tm.getCurrentState().isFinal == true) {
    arr1.css(textArray.length - 1, {"background-color": "#22ff22"});
    jsav.step();
  } else if (result != -1) {
    // If result == 1, that means an invalid character was provided.
    // Line 96 takes care of this by marking the invalid character with red.
    // The last character does not need to provide redundant information.
    arr1.css(textArray.length - 1, {"background-color": "#ff2222"});
    jsav.step();
  }

  jsav.recorded();
}

function showQuestion() {
  // For some reason, question cannot be shown before jsav.recorded() is called.
  // Must refresh page before an input string can be provided.
  jsav.recorded();
  $("#testStringButton").hide();

  var randomString = "";
  var upperBound = Math.floor(Math.random() * 7) + 3;
  for (var i = 0; i < 2 + upperBound; i++) {
    randomString += Math.round(Math.random());
  }
  randomString += "1";
  var answer = tm.play(randomString);
  tm.reset();

  var q = jsav.question("TF", "The Turing Machine shown above accepts the string: " + randomString + "?",
                    {correct: answer,
                    falseLabel: "No",
                    trueLabel: "Yes"});
  q.show();
}

</script>
</body>
</html>
