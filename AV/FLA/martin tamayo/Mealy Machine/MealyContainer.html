<!DOCTYPE html>

<html>
	<head>
		<title>Mealy Container</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
    	<link rel="stylesheet" href="../../resources/customPrompt.css" type="text/css" />
		<base href="./MealyEditor.html" target="iframe">
	</head>
	<body onload="init()">
		<h1>Mealy Machine</h1>
		<div id="dialogueoverlay"></div>
  		<div id="dialoguebox">
  		 	<div>
    			<div id="dialogueboxhead"></div>
      			<div id="dialogueboxbody"></div>
      			<div id="dialogueboxfoot"></div>
    		</div>
  		</div>
		<p align="center" id="multipleTraversals" class="arrayPlace"></p>
		<button onclick="displayEditor()" id="edit">Edit</button>
		<button onclick="displayTraversals()" id="begin">Traverse</button>
		<button onclick="save()" id="saveButton">Save</button>
		<button type="submit" onclick="loadNewFile()">Load</button>
		<input type="file" id="loadFile" onchange="setSaved()">
		<iframe height="650px" width="100%" id="if" name="iframe" onload="onLoadHandler()"></iframe>
		<div id="av" style="display:none"></div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script src="../../resources/MealyPrompt.js"></script>
		<script>
			var jsav = new JSAV("av"),
				jsavArray,
				traversal = "",
				saved = false,
				serialization,
				editing,
				data;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949);
		    
		    var displayEditor = function () {
		    	jsavArray.hide();
		    	if(editing) {
		    		return;
		    	}
		    	editing = true;
		    	serialization = document.getElementById("if").contentWindow.getSerial();
		    	document.getElementById("if").src = "./MealyEditor.html";
		    };
			var displayTraversals = function () {
				var graph = document.getElementById("if").contentWindow.getGraph();
				if (graph.initial == null) {
					window.alert("Mealy traversal requires an initial state.");
					return;
				}
				var edges = graph.edges();
				for (var next = edges.next(); next; next = edges.next()) {
   					if (!testMealy(next.weight())) {
   						window.alert("This automaton is not a Mealy Machine.");
   						return;
   					}
   				}
   				document.getElementById("if").contentWindow.removeND();
				if (document.getElementById("if").contentWindow.testND()) {
					document.getElementById("if").contentWindow.testLambda();
					window.alert("This Mealy Machine is nondeterministic.\nYou cannot run input on it.");
					return;
				}
				var Prompt = new TraversePrompt();
				Prompt.render();
			};
			var traverseInputs = function(inputArray) {
				var graph = document.getElementById("if").contentWindow.getGraph();
				var nodes = graph.nodes();
				for (var next = nodes.next(); next; next = nodes.next()) {
					next.removeClass('current');
				}
				serialization = document.getElementById("if").contentWindow.getSerial();
				var outputArray = [];
				var acceptArray = [];
				document.getElementById("if").contentWindow.readyTraversal();
				for (var i = 0; i < inputArray.length; i++) {
					var outputData = pretraverse(graph, inputArray[i]);
					acceptArray.push(outputData[0]);
					if (outputData[0]) {
    					outputArray.push(outputData[1]);
    				}
    				else {
    					outputArray.push("Rejected");
    				}
  				}
  				var travArray = [];
  				for (var j = 0; j < inputArray.length; j++) {
  					travArray.push(inputArray[j] + "<br><b>" + outputArray[j] +"</b>");
  				}
  				document.getElementById("multipleTraversals").innerHTML = "";
  				jsavArray = jsav.ds.array(travArray, {element: $('.arrayPlace')});
  				for (var k = 0; k < travArray.length; k++) {
  					if(acceptArray[k]){
  						jsavArray.css(k, {"background-color": "green"});
  					}
  					else {
  						jsavArray.css(k, {"background-color": "red"});
  					}
  				}
  				jsavArray.click(arrayClickHandler);
  				jsavArray.show();
  			};
  			function arrayClickHandler(index) {
  				play(this.value(index).split("<br>")[0]);
  			};
			var play = function (inputString) {
				traversal = inputString;
				editing = false;
				document.getElementById("if").src = "./MealyTraversal.html";
			};
			var pretraverse = function (graph, inputString) {
				var accepted = true;
				var outputString = "";
				var currentState = graph.initial;
				var cur;
				for (var i = 0; i < inputString.length; i++) {
				   	cur = traverse(graph, currentState, inputString[i]);
				   	if (cur[0] == null) {
				   		accepted = false;
				   		break;
				   	}
					currentState = cur[0];
					outputString += cur[1];
				}
				return [accepted, outputString];
  			};
			var traverse = function(graph, currentState, letter) {
				var nextState = null;
				var outputChar = "";
				var successors = currentState.neighbors();
				for (var next = successors.next(); next; next = successors.next()) {
					var weights = graph.getEdge(currentState, next).weight().split('<br>');
					for (var j = 0; j < weights.length; j++) {
						var weight = weights[j].split(":");
						var inputChar = weight[0];
						if (letter == inputChar) {
							nextState = next;
							if (weight[1] != lambda && weight[1] != epsilon) {
								outputChar = weight[1];
							}
						}
					}
				}
				return [nextState, outputChar];
			};
			var testMealy = function(edge_label) {
				var weights = edge_label.split("<br>");
				for (var i = 0; i < weights.length; i++) {
					if (weights[i].split(":").length != 2) {
						return false;
					}
				}
				return true;
			};
			var setSaved = function () {
				saved = true
			};
			var save = function () {
				document.getElementById("if").contentWindow.save();
			};
			var loadNewFile = function () {
				if (!saved) {
					return;
				}
				if (jsavArray) {
					jsavArray.hide();
				}
				editing = true;
				data = document.getElementById("loadFile").files[0];
				document.getElementById("if").src = "./MealyEditor.html";
			};
			function onLoadHandler() {
				if (data) {
					var reader = new FileReader();
					reader.onload = loadComplete;
					reader.readAsText(data);
					function loadComplete() {
						var readerData = reader.result;
						document.getElementById("if").contentWindow.initialize(readerData, traversal);
					}
					data = null;
				}
				else if (serialization) {
					document.getElementById("if").contentWindow.initialize(serialization, traversal);
				}
				else {
					var defaultData = '{"nodes":[{"left":753,"top":171,"i":true,"f":false},{"left":505,"top":342,"i":false,"f":false},{"left":1042,"top":199,"i":false,"f":false},{"left":287,"top":123,"i":false,"f":false},{"left":535,"top":0,"i":false,"f":false},{"left":0,"top":89,"i":false,"f":true}],"edges":[{"start":0,"end":1,"weight":"a:j"},{"start":1,"end":2,"weight":"b:f"},{"start":1,"end":5,"weight":"f:8"},{"start":2,"end":4,"weight":"c:l"},{"start":3,"end":1,"weight":"e:p"},{"start":4,"end":3,"weight":"d:a"}]}';
					document.getElementById("if").contentWindow.initialize(defaultData, traversal);
				}
			};
			function init() {
				editing = true;
				document.getElementById("if").src = "./MealyEditor.html";
			};
   		</script>
   	</body>
</html>