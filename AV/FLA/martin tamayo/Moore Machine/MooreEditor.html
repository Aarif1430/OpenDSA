<!DOCTYPE html>

<html>
	<head>
		<title>Moore Editor</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
    	<link rel="stylesheet" href="../../resources/customPrompt.css" type="text/css" />
    	<link rel="stylesheet" href="../../resources/FA.css" type="text/css" />
	</head>
	<body>
		<div id="dialogueoverlay"></div>
  		<div id="dialoguebox">
  		 	<div>
    			<div id="dialogueboxhead"></div>
      			<div id="dialogueboxbody"></div>
      			<div id="dialogueboxfoot"></div>
    		</div>
  		</div>
		<div id="av" style="border:none">
			<button id="undoButton" disabled="true">Undo</button>
			<button id="redoButton" disabled="true">Redo</button>
			<button id="nodeButton">Add Nodes</button>
			<button id="edgeButton">Add Edges</button>
			<button id="moveButton">Move Nodes</button>
			<button id="editButton">Edit Nodes/Edges</button>
			<button id="deleteButton">Delete Nodes/Edges</button>
			<span id='mode'></span>
      		<p class="jsavoutput jsavline"></p>
		</div>
		<button id="layoutButton">Layout</button>
		<button id="ndButton">Highlight Nondeterminism</button>
		<button id="lambdaButton">Highlight &lambda;-Transitions</button>
		<button id="epsilonButton">&epsilon; Mode</button>
		<div>&Sigma;: <span id='alphabet'></span><br>&Lambda;: <span id='mooreOutput'></span></div>
		<div id='download'></div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script src="../../resources/MoorePrompt.js"></script>
		<script src="../../resources/MooreCommands.js"></script>
		<script>
			var jsav = new JSAV("av"),
				first = null,
				selected = null,
				label = null,
				undoStack,
				redoStack,
				data,
				g;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949),
				emptystring = lambda;
			
			var initialize = function(graph, traversal) {
				if (g) {
					localStorage['backup'] = serialize(g);
				}
				data = graph;
				initGraph({layout: "automatic"});
				undoStack = [];
				redoStack = [];
			};
			var initGraph = function(opts) {
				$('.jsavgraph').remove();
				var gg;
				try {
					gg = jQuery.parseJSON(data);
				}
				catch(err) {
					jsav.umsg('Error: Tried to load invalid file.');
					g = localStorage['backup'];
					gg = jQuery.parseJSON(g);
				}
				finally {
					g = jsav.ds.fa($.extend({width: '90%', height: 440}, opts));
					for (var i = 0; i < gg.nodes.length; i++) {
			    		var node = g.addNode('q' + i),
			    			offset = $('.jsavgraph').offset(),
			    			offset2 = parseInt($('.jsavgraph').css('border-width'), 10);
			    		$(node.element).offset({top : parseInt(gg.nodes[i].top) + offset.top + offset2, left: parseInt(gg.nodes[i].left) + offset.left + offset2});
			    		if (gg.nodes[i].i) {
			    			g.makeInitial(node);
			    		}
			    		var outputChar = delambdafyMoore(gg.nodes[i].mooreOutput);
			    		node.mooreOutput(outputChar);
			    		node.stateLabel(gg.nodes[i].stateLabel);
			    		node.stateLabelPositionUpdate();
			  		}
			  		for (var i = 0; i < gg.edges.length; i++) {
			    		if (gg.edges[i].weight !== undefined) {
			    			var w = delambdafy(gg.edges[i].weight);
			    			var edge = g.addEdge(g.nodes()[gg.edges[i].start], g.nodes()[gg.edges[i].end], {weight: w});
		        		}
			    		else {
			    			var edge = g.addEdge(g.nodes()[gg.edges[i].start], g.nodes()[gg.edges[i].end]);
			    		}
			    		edge.layout();
			    	}
			    	updateAlphabet();
			    	updateMooreOutput();
			    	g.click(nodeClickHandler);
					g.click(edgeClickHandler, {edge: true});
					$('.jsavgraph').click(graphClickHandler);
					$('.jsavedgelabel').click(labelClickHandler);
			    	jsav.displayInit();
			    }
		    };
		    function delambdafy(weight) {
		    	var weights = weight.split("<br>");
  				for (var i = 0; i < weights.length; i++) {
    				var symbols = weights[i].split(":");
    				for (var j = 0; j < symbols.length; j++) {
      					if (symbols[j] == "&lambda;") {
        					symbols[j] = lambda;
        					if (lambda != emptystring) {
        						emptyString();
        					}
      					}
      					else if (symbols[j] == "&epsilon;") {
      						symbols[j] = epsilon;
      						if (epsilon != emptystring) {
      							emptyString();
      						}
      					}
    				}
    				weights[i] = symbols.join(":");
  				}
  				return weights.join("<br>");
		    };
		    function delambdafyMoore(outputChar) {
		    	if (!outputChar) {
		    		return emptystring;
		    	}
		    	if (outputChar == "&lambda;") {
        			outputChar = lambda;
        			if (lambda != emptystring) {
        				$("#epsilonButton").click();
        			}
      			}
   				else if (outputChar == "&epsilon;") {
   					outputChar = epsilon;
   					if (epsilon != emptystring) {
   						$("#epsilonButton").click();
   					}
   				}
   				return outputChar;
		    };
			var graphClickHandler = function(e) {
				if ($(".jsavgraph").hasClass("addNodes")) {
					saveMooreState();
					selected = executeAddNode(e.pageY, e.pageX);
					selected.highlight();
					var Prompt = new NodePrompt();
					Prompt.render(selected.value(), selected.hasClass('start'), selected.stateLabel(), selected.mooreOutput());
					selected.unhighlight();
				} 
				else if ($('.jsavgraph').hasClass('moveNodes') && selected != null) {
					saveMooreState();
					executeMoveNode(selected, e.pageY, e.pageX);
					
					selected.unhighlight();
					selected = null;
					e.stopPropagation();
					jsav.umsg('Click a node.');
				}
			};
			var nodeClickHandler = function(e) {	
				if ($(".jsavgraph").hasClass("editNodes")) {
					selected = this;
					selected.highlight();
					var Prompt = new NodePrompt();
					Prompt.render(selected.value(), selected.hasClass('start'), selected.stateLabel(), selected.mooreOutput());
					selected.unhighlight();
   				}
   				else if ($(".jsavgraph").hasClass("addEdges")) {
   					if (!$(".jsavgraph").hasClass("working")) {
						first = this;
						first.highlight();
						$('.jsavgraph').addClass("working");
						jsav.umsg('Select a node to make an edge to.');
		   			}
		   			else {
		   				selected = this;
		   				selected.highlight();
		   				var Prompt = new EdgePrompt();
		   				Prompt.render("");
						$('.jsavgraph').removeClass("working");
						first.unhighlight();
						selected.unhighlight();
						jsav.umsg('Click a node.');
		   			}
   				}
   				else if ($('.jsavgraph').hasClass('moveNodes')) {
   					if (selected) {
   						selected.unhighlight();
   					}
   					selected = this;
   					selected.highlight();
   					jsav.umsg('Click to place node.');
   					e.stopPropagation();
   				}
   				else if ($('.jsavgraph').hasClass('deleteNodes')) {
   					saveMooreState();
   					executeDeleteNode(this);
   				}
			};
			var edgeClickHandler = function(e) {
				if ($('.jsavgraph').hasClass('deleteNodes')) {
					saveFAState();
					executeDeleteEdge(this);
   				}
			};
			var labelClickHandler = function(e) {
				if ($('.jsavgraph').hasClass('editNodes')) {
					label = this;
					var values = $(label).html().split('<br>');
					var Prompt = new EdgePrompt();
		   			Prompt.render(values);
				}
			};
			function cancelNode() {
				g.removeNode(selected);
				undoStack.pop();
				if(undoStack.length == 0) {
					document.getElementById("undoButton").disabled = true;
				}
			};
			function createNode(initial_state, node_label, output_char) {
				executeEditNode(selected, initial_state, node_label, output_char);
			};
			function updateNode(initial_state, node_label, output_char) {
				saveMooreState();
				executeEditNode(selected, initial_state, node_label, output_char);
			};
			function createEdge(edge_label) {
				saveMooreState();
				var edge = executeAddEdge(first, selected, edge_label);
				$(edge._label.element).click(labelClickHandler);
			};
			function updateEdge(edge_label) {
				saveMooreState();
				executeEditEdge(label, edge_label);
			};
   			var updateAlphabet = function() {
	   			g.updateAlphabet();
				$("#alphabet").html("" + Object.keys(g.alphabet).sort());
			};
			var updateMooreOutput = function() {
    			var alphabet = {};
    			var nodes = g.nodes();
    			var w;
    			for (var next = nodes.next(); next; next = nodes.next()) {
          			var letter = next.mooreOutput();
          			if (letter !== emptystring) {
            			if (!(letter in alphabet)) {
              				alphabet[letter] = 0;
            			}
           				alphabet[letter]++;
     				}
    			}
    			$("#mooreOutput").html("" + Object.keys(alphabet).sort());
			};
   			var addNodes = function() {
   				removeModeClasses();
   				removeND();
   				$('.jsavgraph').addClass("addNodes");
   				$("#mode").html('Adding nodes');
   				jsav.umsg('Click to add nodes.');
   			};
   			var addEdges = function() {
   				removeModeClasses();
   				removeND();
   				$(".jsavgraph").addClass("addEdges");
   				$("#mode").html('Adding edges');
   				jsav.umsg('Click a node.');
   			};
   			var moveNodes = function() {
   				removeModeClasses();
   				removeND();
   				$('.jsavgraph').addClass('moveNodes');
   				$("#mode").html('Moving nodes');
   				jsav.umsg('Click a node.');
   			};
   			var editNodes = function() {
				removeModeClasses();
				removeND();
   				$('.jsavgraph').addClass('editNodes');
   				$("#mode").html('Editing nodes and edges');
   				jsav.umsg('Click a node or edge label.');
   			};
   			var deleteNodes = function() {
   				removeModeClasses();
   				removeND();
   				$('.jsavgraph').addClass('deleteNodes');
   				$("#mode").html('Deleting nodes and edges');
   				jsav.umsg('Click a node or edge to delete it.');
   				expandEdges();
   			};
   			var removeModeClasses = function() {
   				$("#mode").html('');
   				jsav.umsg('');
   				if (first) {
   					first.unhighlight();
   					first = null;
   				}
   				if (selected) {
   					selected.unhighlight();
   					selected = null;
   				}
   				if($(".jsavgraph").hasClass("deleteNodes")) {
   					$(".jsavgraph").removeClass("deleteNodes");
   					collapseEdges();
   				}
   				else {
   					$(".jsavgraph").removeClass("addNodes");
   					$(".jsavgraph").removeClass("addEdges");
   					$(".jsavgraph").removeClass("editNodes");
   					$(".jsavgraph").removeClass("moveNodes");
   					$(".jsavgraph").removeClass("working");
   				}
   			};
   			var expandEdges = function() {
   				var edges = g.edges();
				for (var next = edges.next(); next; next = edges.next()) {
					next.g.element.addClass('edgeSelect');
				}
   			};
   			var collapseEdges = function() {
   				var edges = g.edges();
				for (var next = edges.next(); next; next = edges.next()) {
					next.g.element.removeClass('edgeSelect');
				}
   			};
   			var switchEmptyString = function() {
   				saveMooreState();
   				if(!emptyString()) {
   					undoStack.pop();
					if(undoStack.length == 0) {
						document.getElementById("undoButton").disabled = true;
					}
   				}
   			};
   			var emptyString = function() {
   				document.getElementById("epsilonButton").innerHTML = emptystring + " Mode";
   				var graphChanged = false;
   				if (emptystring === lambda) {
   					graphChanged = updateTransitions(epsilon);
   					emptystring = epsilon;
   				}
   				else {
   					graphChanged = updateTransitions(lambda);
   					emptystring = lambda;
   				}
   				document.getElementById("lambdaButton").innerHTML = "Highlight " + emptystring + "-Transitions";
   				return graphChanged;
   			};
   			var updateTransitions = function(greekLetter) {
   				var graphChanged = false;
   				var nodes = g.nodes();
   				for (var next = nodes.next(); next; next = nodes.next()) {
   					if (next.mooreOutput() === emptystring) {
   						next.mooreOutput(greekLetter);
   						graphChanged = true;
   					}
   				}
   				var edges = g.edges();
				for (var next = edges.next(); next; next = edges.next()) {
					var weights = next.weight().split("<br>");
					for (var i = 0; i < weights.length; i++) {
						if (weights[i] === emptystring) {
							weights[i] = greekLetter;
							graphChanged = true;
						}
					}
					next.weight(weights.join("<br>"));
				}
				return graphChanged;
   			};
   			var testND = function() {
   				removeModeClasses();
   				var nd = false;
   				var nodes = g.nodes();
   				for(var next = nodes.next(); next; next = nodes.next()) {
   					var findLambda = false;
   					var findMultiple = false;
   					var transition = g.transitionFunction(next, emptystring);
   					if (transition.length > 0) {
   						findLambda = true;
   					}
   					for (var key in g.alphabet) {
   						transition = g.transitionFunction(next, key);
  						if (transition.length > 1) {
  							findMultiple = true;
  							break;
  						}
					}
					if (findLambda || findMultiple) {
						next.toggleClass('testingND');
						nd = true;
					}
				}
				return nd;
   			};
   			var testLambda = function() {
   				removeModeClasses();
   				var edges = g.edges();
   				for (var next = edges.next(); next; next = edges.next()) {
   					wSplit = next.weight().split('<br>');
   					for (var i = 0; i < wSplit.length; i++) {
   						if (wSplit[i] == emptystring) {
	   						next.g.element.toggleClass('testingLambda');
	   						break;
	   					}
   					}
   				}
   			};
   			var removeND = function() {
   				var nodes = g.nodes();
   				for(var next = nodes.next(); next; next = nodes.next()) {
   					next.removeClass("testingND");
   				}
   				var edges = g.edges();
   				for (var next = edges.next(); next; next = edges.next()) {
   					next.g.element.removeClass('testingLambda');
   				}
   			};
   			var layoutGraph = function() {
   				saveFAState();
   				g.layout();
   			};
			var save = function() {
				var downloadData = "text/json;charset=utf-8," + encodeURIComponent(serialize(g));
				$('#download').html('<a href="data:' + downloadData + '" target="_blank" download="data.json">download JSON</a>');
				jsav.umsg("Saved");
			};
			var getGraph = function() {
				return g;
			};
			var getSerial = function() {
				var serial = serialize(g);
				return serial;
			};
			var readyTraversal = function() {
				removeModeClasses();
				jsav.umsg('Click on an input to trace its traversal.');
			};
			function saveMooreState () {
				data = serialize(g);
				undoStack.push(data);
				redoStack = [];
				document.getElementById("undoButton").disabled = false;
				document.getElementById("redoButton").disabled = true;
				if (undoStack.length > 20) {
					undoStack.shift();
				}
			};
			function undo () {
				removeModeClasses();
				data = serialize(g);
				redoStack.push(data);
				data = undoStack.pop();
				initGraph({layout: "automatic"});
				document.getElementById("redoButton").disabled = false;
				if(undoStack.length == 0) {
					document.getElementById("undoButton").disabled = true;
				}
			};
			function redo () {
				removeModeClasses();
				data = serialize(g);
				undoStack.push(data);
				data = redoStack.pop();
				initGraph({layout: "automatic"});
				document.getElementById("undoButton").disabled = false;
				if(redoStack.length == 0) {
					document.getElementById("redoButton").disabled = true;
				}
			};
			$('#undoButton').click(undo);
			$('#redoButton').click(redo);
			$('#nodeButton').click(addNodes);
			$('#edgeButton').click(addEdges);
			$('#moveButton').click(moveNodes);
			$('#editButton').click(editNodes);
			$('#deleteButton').click(deleteNodes);
			$('#layoutButton').click(layoutGraph);
			$('#ndButton').click(testND);
			$('#lambdaButton').click(testLambda);
			$('#epsilonButton').click(switchEmptyString);
   		</script>
   	</body>
</html>