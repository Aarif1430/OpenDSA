<!DOCTYPE html>

<html>
	<head>
		<title>Moore Container</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
		<base href="./MooreEditor.html" target="iframe">
	</head>
	<body onload="init()">
		<h1>Moore Machine</h1>
		<p align="center" id="multipleTraversals" class="arrayPlace"></p>
		<button onclick="displayEditor()" id="edit">Edit</button>
		<button onclick="displayTraversals()" id="begin">Traverse</button>
		<button onclick="save()" id="saveButton">Save</button>
		<button type="submit" onclick="loadNewFile()">Load</button>
		<input type="file" id="loadFile" onchange="setSaved()">
		<iframe height="650px" width="100%" id="if" name="iframe" onload="onLoadHandler()"></iframe>
		<div id="av" style="display:none"></div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script>
			var jsav = new JSAV("av"),
				jsavArray,
				traversal = "",
				saved = false,
				serialization,
				editing,
				data;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949);
		    
		    var displayEditor = function () {
		    	jsavArray.hide();
		    	if(editing) {
		    		return;
		    	}
		    	editing = true;
		    	serialization = document.getElementById("if").contentWindow.getSerial();
		    	document.getElementById("if").src = "./MooreEditor.html";
		    };
			var displayTraversals = function () {
				var graph = document.getElementById("if").contentWindow.getGraph();
				if (graph.initial == null) {
					window.alert("Moore traversal requires an initial state.");
					return;
				}
				if (document.getElementById("if").contentWindow.testND()) {
					document.getElementById("if").contentWindow.testLambda();
					window.alert("This Moore Machine is nondeterministic.\nYou cannot run input on it.");
					return;
				};
				var inputString = prompt("Input string?");
				var inputArray = inputString.split(',');
				var nodes = graph.nodes();
				for (var next = nodes.next(); next; next = nodes.next()) {
					next.removeClass('current');
				}
				serialization = document.getElementById("if").contentWindow.getSerial();
				var outputArray = [];
				var acceptArray = [];
				document.getElementById("if").contentWindow.readyTraversal();
				for (var i = 0; i < inputArray.length; i++) {
					var outputData = pretraverse(graph, inputArray[i]);
					acceptArray.push(outputData[0]);
					if (outputData[0]) {
    					outputArray.push(outputData[1]);
    				}
    				else {
    					outputArray.push("Rejected");
    				}
  				}
  				var travArray = [];
  				for (var j = 0; j < inputArray.length; j++) {
  					travArray.push(inputArray[j] + "<br><b>" + outputArray[j] +"</b>");
  				}
  				document.getElementById("multipleTraversals").innerHTML = "";
  				jsavArray = jsav.ds.array(travArray, {element: $('.arrayPlace')});
  				for (var k = 0; k < travArray.length; k++) {
  					if(acceptArray[k]){
  						jsavArray.css(k, {"background-color": "green"});
  					}
  					else {
  						jsavArray.css(k, {"background-color": "red"});
  					}
  				}
  				jsavArray.click(arrayClickHandler);
  				jsavArray.show();
  			};
  			function arrayClickHandler(index) {
  				play(this.value(index).split("<br>")[0]);
  			};
			var play = function (inputString) {
				traversal = inputString;
				editing = false;
				document.getElementById("if").src = "./MooreTraversal.html";
			};
			var pretraverse = function (graph, inputString) {
				var accepted = true;
				var outputString = "";
				var currentState = graph.initial;
				var cur;
				for (var i = 0; i < inputString.length; i++) {
				   	cur = traverse(graph, currentState, inputString[i]);
				   	if (cur[0] == null) {
				   		accepted = false;
				   		break;
				   	}
					currentState = cur[0];
					outputString += cur[1];
				}
				return [accepted, outputString];
  			};
			var traverse = function(graph, currentState, letter) {
				var nextState = null;
				var outputChar = "";
				var successors = currentState.neighbors();
				for (var next = successors.next(); next; next = successors.next()) {
					var weights = graph.getEdge(currentState, next).weight().split('<br>');
					for (var j = 0; j < weights.length; j++) {
						if (letter == weights[j]) {
							nextState = next;
							if (next.stateLabel() != lambda && next.stateLabel() != epsilon) {
								outputChar = next.stateLabel();
							}
						}
					}
				}
				return [nextState, outputChar];
			};
			var setSaved = function () {
				saved = true
			};
			var save = function () {
				document.getElementById("if").contentWindow.save();
			};
			var loadNewFile = function () {
				if (!saved) {
					return;
				}
				if (jsavArray) {
					jsavArray.hide();
				}
				editing = true;
				data = document.getElementById("loadFile").files[0];
				document.getElementById("if").src = "./MooreEditor.html";
			};
			function onLoadHandler() {
				if (data) {
					var reader = new FileReader();
					reader.onload = loadComplete;
					reader.readAsText(data);
					function loadComplete() {
						var readerData = reader.result;
						document.getElementById("if").contentWindow.initialize(readerData, traversal);
					}
					data = null;
				}
				else if (serialization) {
					document.getElementById("if").contentWindow.initialize(serialization, traversal);
				}
				else {
					var defaultData = '{"nodes":[{"left":508,"top":201,"i":true,"f":false,"stateLabel":"l"},{"left":345,"top":43,"i":false,"f":false,"stateLabel":"a"},{"left":184,"top":357,"i":false,"f":false,"stateLabel":"p"},{"left":815,"top":42,"i":false,"f":false,"stateLabel":"j"},{"left":660,"top":366,"i":false,"f":false,"stateLabel":"f"}],"edges":[{"start":0,"end":3,"weight":"a"},{"start":0,"end":1,"weight":"d"},{"start":1,"end":2,"weight":"e"},{"start":2,"end":0,"weight":"f"},{"start":3,"end":4,"weight":"b"},{"start":4,"end":0,"weight":"c"}]}';
					document.getElementById("if").contentWindow.initialize(defaultData, traversal);
				}
			};
			function init() {
				editing = true;
				document.getElementById("if").src = "./MooreEditor.html";
			};
   		</script>
   	</body>
</html>