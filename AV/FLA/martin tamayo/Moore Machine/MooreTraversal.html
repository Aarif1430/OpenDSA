<!DOCTYPE html>

<html>
	<head>
		<title>Moore Traversal</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
		<link rel="stylesheet" href="../../resources/FA.css" type="text/css" />
		</style>
	</head>
	<body onload="run()">
		<div id="av" style="border:none">
			<span class="jsavcounter"></span>
			<div class="jsavcontrols">
				<a class="jsavsettings" href="#">Settings</a>
			</div>
      		<p class="jsavoutput jsavline"></p>
      		<p align="center" class="arrayPlace"></p>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script>
			var jsav = new JSAV("av"),
				arr,
				g;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949);

			var initialize = function(graph, traversal) {
				g = graph;
				initGraph({layout: "automatic"});
				$('.jsavcontrols').show();
				run(traversal);
			};
			var initGraph = function(opts) {
				var gg = jQuery.parseJSON(g);
				var graph = jsav.ds.fa($.extend({width: '90%', height: 440}, opts));
				for (var i = 0; i < gg.nodes.length; i++) {
			    	var node = graph.addNode('q' + i),
			    		offset = $('.jsavgraph').offset(),
			    		offset2 = parseInt($('.jsavgraph').css('border-width'), 10);
			    	$(node.element).offset({top : parseInt(gg.nodes[i].top) + offset.top + offset2, left: parseInt(gg.nodes[i].left) + offset.left + offset2});
			    	if (gg.nodes[i].i) {
			    		graph.makeInitial(node);
			    	}
			    	node.stateLabel(gg.nodes[i].stateLabel);
			    	node.stateLabelPositionUpdate();
			  	}
			  	for (var i = 0; i < gg.edges.length; i++) {
			    	if (gg.edges[i].weight !== undefined) {
			    		var edge = graph.addEdge(graph.nodes()[gg.edges[i].start], graph.nodes()[gg.edges[i].end], {weight: (gg.edges[i].weight)});
		        	}
			    	else {
			    		var edge = graph.addEdge(graph.nodes()[gg.edges[i].start], graph.nodes()[gg.edges[i].end]);
			    	}
			    	edge.layout();
			    }
			    g = graph;
		    };
   			var run = function(inputString) {
				var textArray = [];
				g.initial.addClass('current');
				var accepted = true;
				var outputString = "";
				var currentState = g.initial;
				var cur;
				
				for (var i = 0; i < inputString.length; i++) {
    				textArray.push(inputString[i]);
  				}
  				arr = jsav.ds.array(textArray, {element: $('.arrayPlace')});

  				jsav.displayInit();

  				var failingIndex = inputString.length - 1;
				for (var i = 0; i < inputString.length; i++) {
					currentState.removeClass('current');
				   	cur = traverse(currentState, inputString[i]);
				   	if (cur[0] == null) {
				   		accepted = false;
				   		arr.css(i, {"background-color": "red"});
				   		failingIndex = i;
				   		jsav.step();
				   		break;
				   	}
					currentState = cur[0];
					outputString += cur[1];
					currentState.addClass('current');
					arr.css(i, {"background-color": "yellow"});
					jsav.umsg(outputString);
					jsav.step();
				}

				if (accepted) {
					currentState.addClass('accepted');
      				arr.css(inputString.length - 1, {"background-color": "green"});
				}
				else {
					for (var l = failingIndex; l < inputString.length; l++) {
						arr.css(l, {"background-color": "red"});
					}
					jsav.umsg("Rejected");
				}
				jsav.step();
				jsav.recorded();
			};
			var traverse = function(currentState, letter) {
				var nextState = null;
				var outputChar = "";
				var successors = currentState.neighbors();
				for (var next = successors.next(); next; next = successors.next()) {
					var weights = g.getEdge(currentState, next).weight().split('<br>');
					for (var j = 0; j < weights.length; j++) {
						if (letter == weights[j]) {
							nextState = next;
							if (next.stateLabel() != lambda && next.stateLabel() != epsilon) {
								outputChar = next.stateLabel();
							}
						}
					}
				}
				return [nextState, outputChar];
			};
			var testND = function() {
				return false;
			};
			var readyTraversal = function() {
				return;
			};
			var backup = function() {
				return false;
			};
			var save = function() {
				return false;
			};
			var getGraph = function() {
				return g;
			};
			var getSerial = function() {
				var serial = serialize(g);
				return serial;
			}
   		</script>
   	</body>
</html>