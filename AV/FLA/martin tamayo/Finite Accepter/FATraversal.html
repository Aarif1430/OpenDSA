<!DOCTYPE html>

<html>
	<head>
		<title>FA Traversal</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
		<link rel="stylesheet" href="../../resources/FA.css" type="text/css" />
	</head>
	<body onload="run()">
		<div id="av" style="border:none">
			<span class="jsavcounter"></span>
			<div class="jsavcontrols">
				<a class="jsavsettings" href="#">Settings</a>
			</div>
      		<p class="jsavoutput jsavline"></p>
      		<p align="center" class="arrayPlace"></p>
		</div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script>
			var jsav = new JSAV("av"),
				arr,
				g;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949);

			var initialize = function(graph, traversal) {
				g = graph;
				initGraph({layout: "automatic"});
				$('.jsavcontrols').show();
				run(traversal);
			};
			var initGraph = function(opts) {
				var gg = jQuery.parseJSON(g);
				var graph = jsav.ds.fa($.extend({width: '90%', height: 440}, opts));
				for (var i = 0; i < gg.nodes.length; i++) {
			    	var node = graph.addNode('q' + i),
			    		offset = $('.jsavgraph').offset(),
			    		offset2 = parseInt($('.jsavgraph').css('border-width'), 10);
			    	$(node.element).offset({top : parseInt(gg.nodes[i].top) + offset.top + offset2, left: parseInt(gg.nodes[i].left) + offset.left + offset2});
			    	if (gg.nodes[i].i) {
			    		graph.makeInitial(node);
			    	}
			    	if (gg.nodes[i].f) {
			    		node.addClass("final");
			    	}
			    	node.stateLabel(gg.nodes[i].stateLabel);
			    	node.stateLabelPositionUpdate();
			  	}
			  	for (var i = 0; i < gg.edges.length; i++) {
			    	if (gg.edges[i].weight !== undefined) {
			    		var w = delambdafy(gg.edges[i].weight);
			    		var edge = graph.addEdge(graph.nodes()[gg.edges[i].start], graph.nodes()[gg.edges[i].end], {weight: w});
		        	}
			    	else {
			    		var edge = graph.addEdge(graph.nodes()[gg.edges[i].start], graph.nodes()[gg.edges[i].end]);
			    	}
			    	edge.layout();
			    }
			    g = graph;
		    };
		    function delambdafy(weight) {
		    	var weights = weight.split("<br>");
  				for (var i = 0; i < weights.length; i++) {
    				var symbols = weights[i].split(":");
    				for (var j = 0; j < symbols.length; j++) {
      					if (symbols[j] == "&lambda;") {
        					symbols[j] = lambda;
      					}
      					else if (symbols[j] == "&epsilon;") {
      						symbols[j] = epsilon;
      					}
    				}
    				weights[i] = symbols.join(":");
  				}
  				return weights.join("<br>");
		    };
   			var run = function(inputString) {
				var textArray = [];
				g.initial.addClass('current');
				var currentStates = [g.initial];
				currentStates = addLambdaClosure(currentStates);
				var cur = currentStates;
				
				for (var i = 0; i < inputString.length; i++) {
    				textArray.push(inputString[i]);
  				}
  				arr = jsav.ds.array(textArray, {element: $('.arrayPlace')});

  				jsav.displayInit();

  				var failingIndex = inputString.length - 1;
  				var finalIndex = inputString.length - 1;
  				if (!inputString) {
  					finalIndex = 0;
  				}

				for (var i = 0; i < inputString.length; i++) {
					for (var j = 0; j < currentStates.length; j++) {
				   		currentStates[j].removeClass('current');
				   	}
				   	cur = traverse(currentStates, inputString[i]);
				   	if (cur.length == 0) {
				   		arr.css(i, {"background-color": "red"});
				   		failingIndex = i;
				   		jsav.step();
				   		break;
				   	}
					currentStates = cur;
					arr.css(i, {"background-color": "yellow"});
					jsav.step();
				}

				var rejected = true;
				for (var k = 0; k < currentStates.length; k++) {
					if (currentStates[k].hasClass('final') && cur.length > 0) {
						currentStates[k].addClass('accepted');
      					arr.css(finalIndex, {"background-color": "green"});
      					jsav.umsg("Accepted");
						rejected = false;
					}
				}
				if (rejected) {
					for (var l = failingIndex; l < inputString.length - 1; l++) {
						arr.css(l, {"background-color": "red"});
					}
					arr.css(finalIndex, {"background-color": "red"});
					jsav.umsg("Rejected");
				}
				jsav.step();
				jsav.recorded();
			};
			var traverse = function(currentStates, letter) {
				var nextStates = [];
				for (var i = 0; i < currentStates.length; i++) {
					var successors = currentStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = g.getEdge(currentStates[i], next).weight().split('<br>');
						for (var j = 0; j < weight.length; j++) {
							if (letter == weight[j] && !next.hasClass('current')) {
								next.addClass('current');
								nextStates.push(next);
							}
						}
					}
				}
				nextStates = addLambdaClosure(nextStates);
				return nextStates;
			};
			var addLambdaClosure = function(nextStates) {
				lambdaStates = [];
				for (var i = 0; i < nextStates.length; i++) {
					var successors = nextStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = g.getEdge(nextStates[i], next).weight().split('<br>');
						for (var j = 0; j < weight.length; j++) {
							if ((weight[j] == lambda || weight[j] == epsilon) && !next.hasClass('current')) {
								next.addClass('current');
								lambdaStates.push(next);
							}
						}
					}
				}
				if(lambdaStates.length > 0) {
					lambdaStates = addLambdaClosure(lambdaStates);
				}
				for (var k = 0; k < lambdaStates.length; k++) {
					nextStates.push(lambdaStates[k]);
				}
				return nextStates;
			};
			var readyTraversal = function() {
				return;
			};
			var backup = function() {
				return false;
			};
			var save = function() {
				return false;
			};
			var getGraph = function() {
				return g;
			};
			var getSerial = function() {
				var serial = serialize(g);
				return serial;
			}
   		</script>
   	</body>
</html>