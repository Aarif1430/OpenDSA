<!DOCTYPE html>

<html>
	<head>
		<title>FA Container</title>
    	<link rel="stylesheet" href="../../../../JSAV/css/JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
    	<link rel="stylesheet" href="../../resources/customPrompt.css" type="text/css" />
		<base href="./FAEditor.html" target="iframe">
	</head>
	<body>
		<h1>FA Editor</h1>
		<div id="dialogueoverlay"></div>
  		<div id="dialoguebox">
  		 	<div>
    			<div id="dialogueboxhead"></div>
      			<div id="dialogueboxbody"></div>
      			<div id="dialogueboxfoot"></div>
    		</div>
  		</div>
		<p align="center" id="multipleTraversals" class="arrayPlace"></p>
		<button id="edit">Edit</button>
		<button id="begin">Traverse</button>
		<button id="saveButton">Save</button>
		<button type="submit" id="submitButton">Load</button>
		<input type="file" id="loadFile">
		<iframe height="650px" width="100%" id="if" name="iframe"></iframe>
		<div id="av" style="display:none"></div>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="../../../../JSAV/lib/raphael.js"></script>
   		<script src="../../../../JSAV/lib/dagre.min.js"></script>
		<script src="../../../../JSAV/lib/jquery.transit.js"></script>
		<script src="../../../../JSAV/build/JSAV.js"></script>
		<script src="../../resources/serializableGraph.js"></script>
		<script src="../../resources/underscore-min.js"></script>
		<script src="../../resources/FA.js"></script>
		<script src="../../resources/FAPrompt.js"></script>
		<script>
			var jsav = new JSAV("av"),
				jsavArray,
				traversal = "",
				saved = false,
				serialization,
				editing,
				data;

			var lambda = String.fromCharCode(955),
				epsilon = String.fromCharCode(949);

			init();
		    
		    var displayEditor = function () {
		    	jsavArray.hide();
		    	if(editing) {
		    		return;
		    	}
		    	editing = true;
		    	serialization = document.getElementById("if").contentWindow.getSerial();
		    	document.getElementById("if").src = "./FAEditor.html";
		    };
			var displayTraversals = function () {
				var graph = document.getElementById("if").contentWindow.getGraph();
				if (graph.initial == null) {
					window.alert("FA traversal requires an initial state.");
					return;
				}
				var Prompt = new TraversePrompt();
				Prompt.render();
			};
			var traverseInputs = function (inputs) {
				var graph = document.getElementById("if").contentWindow.getGraph();
				var nodes = graph.nodes();
				for (var next = nodes.next(); next; next = nodes.next()) {
					next.removeClass('current');
				}
				serialization = document.getElementById("if").contentWindow.getSerial();
				var travArray = [];
				document.getElementById("if").contentWindow.readyTraversal();
				for (var i = 0; i < inputs.length; i++) {
    				travArray.push(inputs[i]);
  				}
  				document.getElementById("multipleTraversals").innerHTML = "";
  				jsavArray = jsav.ds.array(travArray, {element: $('.arrayPlace')});
  				for (var j = 0; j < travArray.length; j++) {
  					if(willReject(graph, travArray[j])){
  						jsavArray.css(j, {"background-color": "red"});
  					}
  					else {
  						jsavArray.css(j, {"background-color": "green"});
  					}
  				}
  				jsavArray.click(arrayClickHandler);
  				jsavArray.show();
  			};
  			function arrayClickHandler(index) {
  				play(this.value(index));
  			};
			var play = function (inputString) {
				traversal = inputString;
				editing = false;
				document.getElementById("if").src = "./FATraversal.html";
			};
			var willReject = function (graph, inputString) {
				var currentStates = [graph.initial];
				currentStates = addLambdaClosure(graph, currentStates);
				var cur = currentStates;
				for (var i = 0; i < inputString.length; i++) {
					for (var j = 0; j < currentStates.length; j++) {
				   		currentStates[j].removeClass('current');
				   	}
				   	cur = traverse(graph, currentStates, inputString[i]);
				   	if (cur.length == 0) {
				   		break;
				   	}
					currentStates = cur;
				}
				var rejected = true;
				for (var k = 0; k < currentStates.length; k++) {
					currentStates[k].removeClass('current');
					if (currentStates[k].hasClass('final') && cur.length > 0) {
						rejected = false;
					}
				}
				return rejected;
  			};
			var traverse = function(graph, currentStates, letter) {
				var nextStates = [];
				for (var i = 0; i < currentStates.length; i++) {
					var successors = currentStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = graph.getEdge(currentStates[i], next).weight().split('<br>');
						for (var j = 0; j < weight.length; j++) {
							if (letter == weight[j] && !next.hasClass('current')) {
								next.addClass('current');
								nextStates.push(next);
							}
						}
					}
				}
				nextStates = addLambdaClosure(graph, nextStates);
				return nextStates;
			};
			var addLambdaClosure = function(graph, nextStates) {
				lambdaStates = [];
				for (var i = 0; i < nextStates.length; i++) {
					var successors = nextStates[i].neighbors();
					for (var next = successors.next(); next; next = successors.next()) {
						var weight = graph.getEdge(nextStates[i], next).weight().split('<br>');
						for (var j = 0; j < weight.length; j++) {
							if ((weight[j] == lambda || weight[j] == epsilon) && !next.hasClass('current')) {
								next.addClass('current');
								lambdaStates.push(next);
							}
						}
					}
				}
				if(lambdaStates.length > 0) {
					lambdaStates = addLambdaClosure(graph, lambdaStates);
				}
				for (var k = 0; k < lambdaStates.length; k++) {
					nextStates.push(lambdaStates[k]);
				}
				return nextStates;
			};
			var setSaved = function () {
				saved = true
			};
			var save = function () {
				document.getElementById("if").contentWindow.save();
			};
			var loadNewFile = function () {
				if (!saved) {
					return;
				}
				if (jsavArray) {
					jsavArray.hide();
				}
				editing = true;
				data = document.getElementById("loadFile").files[0];
				document.getElementById("if").src = "./FAEditor.html";
			};
			function onLoadHandler() {
				if (data) {
					var reader = new FileReader();
					reader.onload = loadComplete;
					reader.readAsText(data);
					function loadComplete() {
						var readerData = reader.result;
						document.getElementById("if").contentWindow.initialize(readerData, traversal);
					}
					data = null;
				}
				else if (serialization) {
					document.getElementById("if").contentWindow.initialize(serialization, traversal);
				}
				else {
					var defaultData = '{"nodes":[{"left":753.90625,"top":171.109375,"i":true,"f":false},{"left":505.890625,"top":342,"i":false,"f":false},{"left":1042,"top":199.40625,"i":false,"f":false},{"left":287.90625,"top":123.625,"i":false,"f":false},{"left":535.921875,"top":0,"i":false,"f":false},{"left":0,"top":89.234375,"i":false,"f":true}],"edges":[{"start":0,"end":1,"weight":"a"},{"start":0,"end":2,"weight":"b"},{"start":1,"end":3,"weight":"a"},{"start":3,"end":4,"weight":"b"},{"start":3,"end":5,"weight":"a"},{"start":4,"end":0,"weight":"a"},{"start":5,"end":3,"weight":"g"}]}';
					document.getElementById("if").contentWindow.initialize(defaultData, traversal);
				}
			};
			function init() {
				editing = true;
				document.getElementById("if").src = "./FAEditor.html";
			};
			$('#edit').click(displayEditor);
			$('#begin').click(displayTraversals);
			$('#saveButton').click(save);
			$('#submitButton').click(loadNewFile);
			$('#loadFile').change(setSaved);
			$('#if').load(onLoadHandler);
   		</script>
   	</body>
</html>