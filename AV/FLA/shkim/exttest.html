<!DOCTYPE html>
<html>
	<head>
		<title>DFA test</title>
    	<link rel="stylesheet" href="./JSAV.css" type="text/css" media="screen" title="no title" charset="utf-8" />
		<style>
			#av {
				width: 98%;
      			position: relative;
			}
			.current{
				background-color: yellow;
			}
			.start{	
				background-color: green;
			}
			.final{
				border: 3px double;
			}
			p.jsavoutput.jsavline {
				height: 40px;
			}
			.jsavlabel {
      			font-size: 2em;
      			text-align: center;
    		}
    		.jsavcounter {
      			position: absolute;
      			top: 15px;
    		}
    		.jsavcanvas { height: 500px;}
    		.jsavgraph {
    			outline: 1px black solid;
    			border: 10px transparent solid;
    		}
    		.jsavnode { cursor: pointer;}
		</style>
	</head>
	<body>
		
		<h1>test</h1>
		<div id="av">
			<a class="jsavsettings" href="#">Settings</a>
			<p align="center" class="jsavexercisecontrols"></p>
			<div class="jsavcontrols"></div><span class="jsavcounter"></span>
      		<p class="jsavoutput jsavline"></p>
      		<p align="center" class="arrayPlace"></p>
		</div>
		<!-- <button onclick="addState()" id="addState">Add state</button> -->
		<button onclick="play()" id="begin">Traverse</button>
		<button onclick="g.layout()">Layout</button>
		<button onclick="edit()" id="editButton">Toggle Editing Mode</button>
		<span id='mode'></span>
		
		<script
   			src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js">
		</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
		<script src="./lib/raphael.js"></script>
   		<script src="./lib/dagre.min.js"></script>
		<script src="./lib/jquery.transit.js"></script>
		<script src="./JSAVedit.js"></script>
		<script>
			var jsav = new JSAV("av");
			var textArray = [];
			var counter = 0;				//keeps track of the numbering of the states
			var startState;
			var selectedNode = null;

			/*
			graph:
			initial state is filled green
			current states (during slideshow) are filled blue
			array:
			characters already traversed are highlighted yellow
			if a character is not accepted, it is filled red
			if the inputted string passes, the final character is filled green
			*/

			var initGraph = function(opts) {
	      		//var g = jsav.ds.graph($.extend({width: $('#av').width(), height: $('#av').height()}, opts));
				var g = jsav.ds.fa($.extend({width: 500, height: 350}, opts));
	      		g.css('width', '90%');
	      		g.css('height', '90%');
	      		var a = g.addNode("q0"),		
	          		b = g.addNode("q1"),
	          		c = g.addNode("q2"),
	          		d = g.addNode("q3"),
	          		e = g.addNode("q4"),
	          		f = g.addNode("q5");
	          
	          	a.addClass("start");
	          	startState = a;
	          	f.addClass("final");

			    g.addEdge(a, b, {weight: 'a'});
			    //g.addEdge(b, a, {weight: 'c'});	
			    //module does not support multiple edges between same pair
			    //also lacks loops
			    g.addEdge(a, c, {weight: 'b'});
			    g.addEdge(b, d, {weight: 'a'});
			    g.addEdge(e, a, {weight: 'a'});
			    g.addEdge(d, e, {weight: 'b'});
			    g.addEdge(d, f, {weight: 'a'});
			    return g;
		    };

		    
		    var g = initGraph({layout: "automatic"});

		    g.layout();
   			jsav.displayInit();
   			

   			

   			//================================
   			var edit = function() {
				if ($(".jsavgraph").hasClass("addNodes")) {
   					$(".jsavgraph").removeClass("addNodes");
   					$(".jsavgraph").addClass("addEdges");
   					$("#mode").html('Adding edges');
   				} else if ($(".jsavgraph").hasClass("addEdges")) {
   					$(".jsavgraph").removeClass("addEdges");
   					$('.jsavgraph').addClass('moveNodes');
   					$("#mode").html('Moving nodes');
   				} else if ($(".jsavgraph").hasClass("moveNodes")) {
   					$(".jsavgraph").removeClass("moveNodes");
   					$('.jsavgraph').addClass('editNodes');
   					$("#mode").html('Editing nodes');
   				} else if ($('.jsavgraph').hasClass("editNodes")) {
   					$(".jsavgraph").removeClass("editNodes");
   					$("#mode").html('');
   				} else {
   					$('.jsavgraph').addClass("addNodes");
   					$("#mode").html('Adding nodes');
   					//jsav.displayInit();
   				}
   			};

			$(".jsavgraph").click(function(e) {
				if ($(".jsavgraph").hasClass("addNodes")) {
					
					//var offset = g.bounds();
					var newNode = g.addNode();
					var nodeX = newNode.element.width()/2.0;
					var nodeY = newNode.element.height()/2.0;

					//newNode.css("left", e.pageX - offset.left);
					//newNode.css("top", e.pageY - offset.top);

					newNode.addClass("temp");
					$(".temp").offset({top: e.pageY - nodeY, left: e.pageX - nodeX});
					newNode.removeClass("temp");
				} else if ($('.jsavgraph').hasClass('moveNodes') && selectedNode != null) {
					var nodeX = selectedNode.element.width()/2.0;
					var nodeY = selectedNode.element.height()/2.0;
					selectedNode.addClass("temp");
					$(".temp").offset({top: e.pageY - nodeY, left: e.pageX - nodeX});
					selectedNode.removeClass("temp");
					var edges = g.edges();
					for (var next = edges.next(); next; next = edges.next()) {
						if (next.start().equals(selectedNode) || next.end().equals(selectedNode)) {
							next.layout();
						}
					}
					selectedNode.unhighlight();
					selectedNode = null;
					e.stopPropagation();
				}
			});
			//================================

			g.click(function(e) {	
				if ($(".jsavgraph").hasClass("editNodes")) {
					this.highlight();
					
					var input = prompt("delete state, make state initial, or make state final? D, I, or F");
					if (input === null) {
						this.unhighlight();
						return;
					}
					input = input.toUpperCase();
					if (input == 'D') {
						g.removeNode(this);
					}
					else if (input == 'I') {
						for (var i = 0; i < g.nodeCount(); i++) {
							g.nodes()[i].removeClass('start');
						}
						this.addClass("start");
						startState = this;
					} else if (input == 'F') {
						this.toggleClass('final');
					} 
		   			this.unhighlight();
		   			//jsav.displayInit();
   				} else if ($(".jsavgraph").hasClass("addEdges")) {
   					this.highlight();
   					if (!$(".jsavgraph").hasClass("working")) {
						first = this;
						$('.jsavgraph').addClass("working");
						var input2 = confirm("select a node to make an edge to");
		   			} else {
		   				var input2 = prompt("accepted character?");
		   				var newEdge;
						if (input2 === "") {
							newEdge = g.addEdge(first, this, {weight: "\&lambda;"});
						} else if (input2 != null) {
							newEdge = g.addEdge(first, this, {weight: input2});
						} 
						if (!(typeof newEdge === 'undefined')) {
							newEdge.layout();
						}
						$('.jsavgraph').removeClass("working");
						first.unhighlight();
						this.unhighlight();
		   			}
   				} else if ($('.jsavgraph').hasClass('moveNodes')) {
   					this.highlight();
   					selectedNode = this;
   					confirm("click to place node");
   					e.stopPropagation();
   				}
 			});
			
			//====================
			//temp:

			var play = function() {
				jsav.displayInit();
				var inputString = prompt("input string?", "aaa");
				if (inputString == null) {
					jsav.recorded();
				}
				$("button").hide();			//disable buttons
				var currentState;
				currentState = startState;
				currentState.addClass('current');
				var cur;
				for (var i = 0; i < inputString.length; i++) {
    				textArray.push(inputString[i]);
  				}

  				var arr = jsav.ds.array(textArray, {element: $('.arrayPlace')});

				for (var i = 0; i < inputString.length; i++) {
				   	cur = traverse(currentState, inputString[i]);
				   	if (cur == null) {
				   		arr.css(i, {"background-color": "red"});
				   		jsav.step();
				   		break;
				   	}
				   	currentState.removeClass('current');
					currentState = cur;
					currentState.addClass('current');
					arr.css(i, {"background-color": "yellow"});
					jsav.step();
				}
				if (currentState.hasClass('final') && cur != null) {
      				arr.css(inputString.length - 1, {"background-color": "green"});
      				jsav.umsg("accepted");
				} else {
					arr.css(inputString.length - 1, {"background-color": "red"});
					jsav.umsg("rejected");
				}
				jsav.step();
				jsav.recorded();	
			};

			var traverse = function(currentState, letter) {
				var successors = currentState.neighbors();
				for (var next = successors.next(); next; next = successors.next()) {
					var weight = g.getEdge(currentState, next).weight().split(',');
					for (var i = 0; i < weight.length; i++) {
						if (letter == weight[i]) {
							return next;
						}
					}
				} 
				return null;
			};
			//======================
			
			
   		</script>
   	</body>
  </html>