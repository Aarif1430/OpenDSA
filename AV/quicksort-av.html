<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Quicksort AV</title>
  <link href="opendsaAV.css" title="CSS" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="../JSAV/css/JSAV.css" type="text/css" />
  <style>

  #container {
    width: 800px;
    height: 565px;
    border: 1px solid black;
    background-color: #efe;
    padding: 10px;
    overflow-y: visible;
    overflow-x: hidden;
  }

  #avcontainer{
    overflow: visible;
  }

  div h1 {
    background-color: #efe;
    margin: 5px;
  }
  
  .jsavcontainer {
    background-color: #efe;
    border: none;
    padding: 0px;
  }
  
  .jsavcounter {
    position: absolute;
    width: 100px;
  }
  
  .jsavarray {
    padding-left:0;
    position: absolute;
  }
  
  p.jsavoutput.jsavline {
    height: 30px;
    margin: 0;
  }
  
  #about {
    float: right;
  }
  
  a.jsavsettings {
    display: block;
    margin-top: 10px;
    margin-left: 10px;
  }
  
  form {
    clear: both;
  }
  </style>
</head>

<body>
<div id="container">
  <input type="button" id="about" name="about" value="About" style="margin-top:10px;"/>
  <a class="jsavsettings" href="#">Settings</a>
  <h1 style="">Quicksort Visualization</h1>

  <form id="ssperform">
    <p>
      <label for="arraysize">&nbsp;List size:&nbsp;</label>
      <select id="arraysize">
        <option value = 5>5</option>
        <option value = 6>6</option>
        <option value = 7>7</option>
        <option selected value = 8>8</option>
        <option value = 9>9</option>
        <option value = 10>10</option>
        <option value = 11>11</option>
        <option value = 12>12</option>
        <option value = 13>13</option>
        <option value = 14>14</option>
        <option value = 15>15</option>
        <option value = 16>16</option>
      </select>
      <label for="arrayValues">&nbsp;Your values (optional):&nbsp;</label>
      <input size="60" name="arrayValues" id="arrayValues" type="text" />
	  <br />
      <input type="button" name="run" value="Run" />
      <input type="button" name="reset" value="Reset" />
    </p>
  </form>
  <div id="avcontainer">
    <span class="jsavcounter"></span>
    <div class="jsavcontrols"></div>
    <p class="jsavoutput jsavline" readonly="readonly"></p>
  </div> <!--avcontainer-->
</div> <!--container-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="../JSAV/lib/jquery.transform.light.js"></script>
<script src="../JSAV/build/JSAV-min.js"></script>

<script>
(function($) {
  // Number of values in the array
  var ASize = $('#arraysize').val();
  // The array of numbers.
  var theArray = [];

  // check query parameters from URL
  var params = JSAV.utils.getQueryParameter();
  if ("array" in params) { // set value of array pick if it is a param
    $('#arrayValues').val(params["array"]).prop("disabled", true);
  }
  
  // create a new settings panel and specify the link to show it
  var settings = new JSAV.utils.Settings($(".jsavsettings"));
  
  var context = $("#ssperform");
  var emptyContent = $("#avcontainer").html();
  var av, // for JSAV av
    arr;  // for the JSAV array

  // Connect action callbacks to the HTML entities
  $('input[name="about"]').click(about);
  $('input[name="run"]', context).click(runIt);
  $('input[name="reset"]', context).click(reset);

  // Process About button: Pop up a message with an Alert
  function about() {
    var mystring = "Quicksort Algorithm Visualization\nWritten by Daniel Breakiron\nCreated as part of the OpenDSA hypertextbook project.\nFor more information, see http://algoviz.org/OpenDSA\nWritten during Summer, 2012\nLast update: July, 2012\nJSAV library version " + JSAV.version();
    alert(mystring);
  }

  // Process Reset button: Reinitialize the output textbox and the AV
  function reset(flag) {
    if (av) {
      av.clearumsg();
      $("#avcontainer").unbind().html(emptyContent);
    }
    // Clear the array values field, when no params given and reset button hit
    if (flag !== true) {
      if (!$('#arrayValues').prop("disabled")) {
        $('#arrayValues').val("");
      }
    }
  }

  // Validate the user-defined array values
  function processArrayValues() {
    var i, 
        num, 
        msg = "Must be 5 to 16 positive integers";
    // Convert user's values to an array,
    // assuming values are space separated
    theArray = $('input[name="arrayValues"]', context).val().match(/[0-9]+/g) || [];
    if (theArray.length === 0) { // Empty field
      theArray.length = 0;
      return true;
    }
    if (theArray.length < 5 || theArray.length > 16) {
      alert(msg);
      theArray.length = 0;
      return false;
    }
    for (i=0; i<theArray.length; i++) {
      theArray[i] = Number(theArray[i]);
      if (isNaN(theArray[i]) || theArray[i] < 0) { 
        alert(msg);
        theArray.length = 0;
        return false;
      }
    }
    $('#arraysize').val(theArray.length);
    return true;
  }
  
  // Execute the "Run" button function
  function runIt() {
    var newSize = $('#arraysize').val();

    if (processArrayValues()) { // if it is false, we got junk user
                                // needs to fix
      if (theArray.length === 0) { // Make a random  array
        ASize = newSize;
        theArray.length = 0; // Out with the old
        // Give random numbers in range 0..999
        for (i=0; i < ASize; i++) {
          theArray[i] = Math.floor(Math.random()*1000);
        }
      }
      else { // Use the values we got out of the user's list
        ASize = theArray.length;
      }
	  
	  
	  // FOR TESTING PURPOSES
	  //theArray = [72, 6, 57, 88, 60, 42, 83, 73, 48, 85];
	  
	  
      reset(true); // Reset any previous visualization
      av = new JSAV("avcontainer"); // initialize JSAV ..
      // .. and the array. use the layout the user has selected
      arr = av.ds.array(theArray, {indexed: true});
	  
      
      // BEGIN QUICKSORT IMPLEMENTATION
	  
      // Dynamically determine the canvas width using the centered alignment of the first block
      leftEdge = parseFloat(arr.element.css("left"));

	  var level = 1;
	  var leftOffset = 0;
	  
      av.displayInit();
	  
      quicksort(arr, level, leftOffset);

      // END QUICKSORT IMPLEMENTATION
	  
      av.umsg("Done sorting!");
      av.recorded(); // mark the end
    }
  }
  
  // The space required for each row to be displayed
  var canvasWidth = 0;
  var leftEdge = 0;
  var blockWidth = 47;
  
  function quicksort(arr, level, leftOffset)
  {
	var i = 0;
	var j = arr.size() - 1;
	
	// Correctly position the array
    setPosition(arr, level, leftOffset);
  
	av.umsg("Select the pivot");
	var pivotIndex = Math.floor((i + j) / 2);
	arr.highlightPivot(pivotIndex);
	av.step();
	
	av.umsg("Move the pivot to the end");
	arr.toggleArrow(j);
	av.step();
	
	arr.swap(pivotIndex, j);
	av.step();
	arr.toggleArrow(j)
	
	av.umsg("Partition the array");
	av.step();
	// k will be the first position in the right subarray
	var k = partition(arr, i, j, arr.value(j));
	
	arr.toggleArrow(k);
	av.umsg("All elements to the right of this value are less than the pivot and all elements to the right are greater than or equal to the pivot");
	av.step();
	arr.toggleArrow(k);
	
	av.umsg("Move the pivot to its final location");
	arr.swap(k, j);
	arr.highlightSorted(k);
	av.step();
	
	// Create and display sub-arrays
	var subArr1 = arr.slice(i, k);
	if (subArr1.length == 1) {
		av.umsg("Left sublist contains a single element which means it is sorted");
		av.step();
		arr.highlightSorted(i);
	}
	else {
		var avSubArr1 = av.ds.array(subArr1, {indexed: true, center: false});
	}
	
	var subArr2 = arr.slice(k + 1, j + 1);
	if (subArr2.length == 1) {
		av.umsg("Right sublist contains a single element which means it is sorted");
		av.step();
		arr.highlightSorted(k + 1);
	}
	else {
		var avSubArr2 = av.ds.array(subArr2, {indexed: true, center: false});
	}
	
	// Sort left partition
	if (subArr1.length > 1)
	{
		av.umsg("Call quicksort on the left sublist");
		av.step();
		quicksort(avSubArr1, level + 1, leftOffset);
	}
	
	// Sort right partition
	if (subArr2.length > 1)
	{
		av.umsg("Call quicksort on the right sublist");
		av.step();
		quicksort(avSubArr2, level + 1, leftOffset + k + 1);
	}
  }
  
  
  function partition(arr, l, r, pivot)
  {
    l -= 1;
	
	while (l < r)
	{	  
	  av.umsg("Select a value larger than the pivot to swap to the right");
	  while ((arr.value(++l) < pivot))
	  {
		arr.highlight(l);
		av.step();
		arr.unhighlight(l);
	  }
	  
	  arr.highlight(l);
	  av.step();
	  
	  
	  av.umsg("Select a value smaller than the pivot to swap to the left");
	  while ((r != 0) && (arr.value(--r) > pivot) && (r > l)) //((r != 0) && (arr.value(r) > pivot))
	  {
		arr.highlight(r);
		av.step();
		arr.unhighlight(r);
	  }
	  
	  arr.highlight(r);
	  av.step();
	  
	  // Stop when all elements have been appropriately swapped
	  if (l >= r)
	  {
	    arr.unhighlight([l, r]);
		break;
	  }
	  
	  //Highlight elements to swap
	  av.umsg("Swap the selected values");
	  arr.swap(l, r);
	  //arr.unhighlight([l, r]);
	  av.step();
	  arr.unhighlight([l, r]);
	}
	
	// Return first position in right partition
	return l; 
  }
  
  function partition_broken(arr, l, r, pivot)
  {
    r -= 1;
	
	//alert("partition");
  
	while (l < r)
	{
	  /*
	  while ((arr.value(l) < pivot) && (arr.value(r) > pivot) && (r != 0) && (l < r))
	  {
	    arr.highlight(l);
		arr.highlight(r);
	    alert("l: " + l + ", r: " + r);
		av.step();
	    arr.unhighlight(l++);
		arr.unhighlight(r--);
	  }
	  */
	  
	  
	  //alert("1 l: " + l + ", r: " + r);
	  
	  av.umsg("Select a value larger than the pivot to swap to the right");
	  while ((arr.value(l) < pivot))
	  {
		arr.highlight(l);
		av.step();
		arr.unhighlight(l++);
	  }
	  
	  arr.highlight(l);
	  av.step();
	  
	  
	  av.umsg("Select a value smaller than the pivot to swap to the left");
	  while ((r > l) && (arr.value(r) > pivot)) //((r != 0) && (arr.value(r) > pivot))
	  {
		arr.highlight(r);
		av.step();
		arr.unhighlight(r--);
	  }
	  
	  arr.highlight(r);
	  av.step();
	  
	  // Stop when all elements have been appropriately swapped
	  if (l >= r)
	  {
	    arr.unhighlight([l, r]);
		break;
	  }
	  
	  //Highlight elements to swap
	  av.umsg("Swap the selected values");
	  arr.swap(l, r);
	  //arr.unhighlight([l, r]);
	  av.step();
	}
	
	// Return first position in right partition
	return l; 
  }
  
  // var k = partition_working(arr, i - 1, j, arr.value(j));
  function partition_working(arr, l, r, pivot)
  {
	while (l < r)
	{
	  // Move bounds inward until they meet
	  while (arr.value(++l) < pivot);
	  while ((r != 0) && (arr.value(--r) > pivot));
	  
	  // Stop when all elements have been appropriately swapped
	  if (l >= r) break;
	  
	  //Highlight elements to swap
	  arr.highlight([l, r]);
	  av.step();
	  arr.swap(l, r);
	  arr.unhighlight([l, r]);
	  av.step();
	}
	
	// Return first position in right partition
	return l; 
  }
  
  /**
   * Calculates and sets the appropriate 'top' and 'left' CSS values based 
   * on the specified array's level of recursion, column number and the 
   * number of elements in the array
   *
   * arr - the JSAV array to set the 'top' and 'left' values for
   * level - the level of recursion, the full-size array is level 1
   * leftOffset - the number of blocks from the left the array should be positioned
   */
  function setPosition(arr, level, leftOffset) {
	var left = leftEdge + leftOffset * blockWidth;
	var rowHeight = 80;
    var top = rowHeight * (level - 1);

    // Set the top and left values so that all arrays are spaced properly
    arr.element.css({"left": left, "top": top});
  }
  
  /**
   * Extends the JSAV AV array to have the slice functionality of JavaScript arrays
   */
  JSAV._types.ds.AVArray.prototype.slice = function(start, end) {
    var array = new Array();
    
    for (var i = 0; i < (end - start); i++)
    {
      array[i] = this.value(start + i);
    }
    
    return array;
  }
  
  /**
   * Convenience function for highlighting the pivot value in blue
   */ 
  JSAV._types.ds.AVArray.prototype.highlightPivot = function(index) {
    this.css(index, {"background-color": "#ddf" });
  };
  
  /**
   * Convenience function for highlighting sorted values
   */
  JSAV._types.ds.AVArray.prototype.highlightSorted = function(index) {
    this.css(index, {"background-color": "#ffffcc" });
  };
})(jQuery);
</script>
</body>
</html>
