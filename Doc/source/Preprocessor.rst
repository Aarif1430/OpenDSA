.. _Preprocessor:

OpenDSA Document Processor
==============================

The main motivation behind building a document processor within OpenDSA was: 
We wanted the ability to number document objects (figures, and tables, and equations), and display 
numbered references.

When we started the project DocUtils was not providing such features you can
view DocUtils To Do list at `<http://docutils.sourceforge.net/docs/dev/todo.html>`_.

Overview
--------

The document processor works as a three-pass compiler. The first two passes are executed
on ``rst`` files before running Sphinx, and the last pass is run against ``html`` files produced
by Sphinx. It produces three files two containing ducuments and objects numbers and one to check if
the document has been modified. All global variables are declared in a separate file (config.py).

First-Pass
----------

INPUT
    Modules ``rst`` source files.

OUTPUT
    A file JSON (page_chapter.json) containing a dictionary of modules and their associate chapter.

DESCRIPTION
    During the first pass, the document processor creates a dictionary of the highlest level elements in the 
    document that is modules. The dictionary contains the tuples :``(module_name,[chapter_name,chapter_number])``.

Second-Pass
-----------

INPUT
    Modules ``rst`` source files.

OUTPUT
    A JSON file (table.json) containing a dictionary of all documents objects and their appearance number.

DESCRIPTION
    During the second pass, the document processor creates a dictionary of all the objects inside modules. The appearance number is the concatenation of ``chapter_number``, ``module_number``, and ``object_number``. The dictionary contains the tuples :``(object_name,appearance_number.)``.

Integration with Sphinx
-----------------------

The ``numref`` (:ref:`numref`) directive get document objects (figures, and tables, and equations) number from the output of the document preprocessor and uses it as hyperlink text for cross referencing.

Third-Pass
----------

INPUT
    Modules ``html`` files generated by Sphinx.

OUTPUT
    Modified ``html`` files with updated table of content, and navigation bar, and section numbering to display the rigth numbers.

DESCRIPTION
   During the third pass, the document processor parses the html files and replaces headers and section numbers with the one generated during the first two passes. Since our processor do not modify Sphinx document tree, we have to modify ``html`` files to replace Sphinx number with preprocessor number. This phase applies only to the Table Of Content, the navigation bar, pages headers and sections.
